@model IEnumerable<DangKyKhamBenh.Models.ViewModels.BenhNhan>
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewBag.Title = "Quản lý bệnh nhân";
    ViewBag.Active = "Patients";
}

<style>
    /* Giới hạn độ rộng các cột dài, cắt bớt bằng ...  */
    .tbl-patient .text-enc {
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-family: Consolas, monospace; /* nhìn chuỗi mã hóa dễ đọc hơn */
        font-size: 0.85rem;
    }

    .tbl-patient .col-name {
        max-width: 220px;
    }

    .tbl-patient .col-contact {
        max-width: 230px;
    }

    .tbl-patient th,
    .tbl-patient td {
        vertical-align: middle !important;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Danh sách bệnh nhân</h4>

    <form class="d-flex gap-2" method="get" action="@Url.Action("Patients","Admin")">
        <input name="kw"
               class="form-control"
               style="width:260px"
               placeholder="Tìm mã BN, họ tên, username..."
               value="@Request["kw"]" />
        <button class="btn btn-primary">
            <i class="bi bi-search"></i> Tìm
        </button>
    </form>
</div>

<div class="table-responsive">
    <table class="table table-sm table-striped table-hover align-middle tbl-patient">
        <thead class="table-light">
            <tr>
                <th style="width:90px;">Mã BN</th>
                <th class="col-name">Họ tên</th>
                <th style="width:140px;">Username</th>
                <th class="col-contact">Liên hệ</th>
                <th style="width:115px;">Ngày sinh</th>
                <th style="width:110px;">Trạng thái</th>
                <th style="width:220px;">Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var b in Model)
            {
                <tr>
                    <td>
                        <span class="badge bg-light text-dark border">
                            @b.MaBenhNhan
                        </span>
                    </td>

                    <td class="col-name">
                        <div class="fw-semibold text-enc" title="@b.HoTen">
                            @b.HoTen
                        </div>
                        <div class="text-muted small text-enc" title="@b.DiaChi">
                            @b.DiaChi
                        </div>
                    </td>

                    <td>
                        <span class="text-enc" title="@b.UserName">
                            @b.UserName
                        </span>
                    </td>

                    <td class="col-contact">
                        <div class="text-enc" title="@b.SoDienThoai">
                            @b.SoDienThoai
                        </div>
                        <div class="text-muted small text-enc" title="@b.Email">
                            @b.Email
                        </div>
                    </td>

                    <td>@(b.NgaySinh?.ToString("dd/MM/yyyy"))</td>

                    <td>
                        @if (string.Equals(b.TrangThai, "ACTIVE", StringComparison.OrdinalIgnoreCase))
                        {
                            <span class="badge bg-success">ACTIVE</span>
                        }
                        else if (string.Equals(b.TrangThai, "LOCKED", StringComparison.OrdinalIgnoreCase))
                        {
                            <span class="badge bg-danger">LOCKED</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@b.TrangThai</span>
                        }
                    </td>

                    <td>
                        <div class="d-grid gap-2 d-md-inline-flex">
                            <a class="btn btn-outline-primary" 
                               href="@Url.Action("EditPatient","Admin", new { id = b.MaBenhNhan })">
                                Sửa
                            </a>

                            @using (Html.BeginForm("TogglePatientStatus", "Admin", FormMethod.Post,
                                   new { style = "display:inline-block" }))
                            {
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@b.MaBenhNhan" />
                                if (string.Equals(b.TrangThai, "ACTIVE", StringComparison.OrdinalIgnoreCase))
                                {
                                    <button class="btn btn-outline-warning" type="submit">Khóa</button>
                                }
                                else
                                {
                                    <button class="btn btn-outline-success" type="submit">Mở</button>
                                }
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
